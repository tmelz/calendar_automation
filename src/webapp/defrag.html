<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Defrag Calendar View</title>
    <!-- Include Vue.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <style>
      /* Basic Reset and Styling */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f4f8;
        color: #333;
      }

      h2 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 24px;
        display: flex;
        align-items: center;
      }

      #app {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Spinner Styles */
      .spinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        z-index: 1000;
      }

      @keyframes spin {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      /* Date Selector Styling */
      .date-selector {
        margin-bottom: 20px;
      }

      /* Explainer Text Styling */
      .explainer-text {
        margin-bottom: 10px;
        font-size: 14px;
        color: #555;
      }

      /* Calendar Container Styling */
      .calendar-container-wrapper {
        display: flex;
        flex-direction: row;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
      }

      /* Time Labels Styling */
      .time-labels {
        width: 60px;
        flex-shrink: 0;
        background-color: #f8f9fa;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        padding-top: 35px; /* Align with hour lines */
        box-sizing: border-box;
      }

      .time-label {
        height: 60px; /* Height matches hour line spacing */
        font-size: 12px;
        color: #666;
        line-height: 50px;
        text-align: right;
        padding-right: 5px;
      }

      /* Calendar Days Styling */
      .calendar-container {
        display: flex;
        flex-grow: 1;
        position: relative;
      }

      .calendar-day {
        flex: 1;
        min-width: 150px;
        padding: 10px;
        position: relative;
        border-right: 1px solid #e0e0e0;
        box-sizing: border-box;
      }

      .calendar-day:last-child {
        border-right: none;
      }

      .day-header {
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #3498db;
        color: #2c3e50;
      }

      /* Events Container Styling */
      .events-container {
        position: absolute;
        top: 50px; /* Align with time labels */
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none; /* Allows clicking on events */
        overflow: hidden; /* Prevents events from overflowing */
      }

      /* Hour Line Styling */
      .hour-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
        background-color: #e0e0e0;
      }

      /* Event Styling */
      .event {
        border-radius: 4px;
        padding: 5px;
        margin: 1px 0;
        position: absolute;
        overflow: hidden;
        box-sizing: border-box;
        font-size: 12px;
        line-height: 1.2;
        cursor: pointer;
        transition: all 0.5s ease;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 4px;
        /* Ensure events are above hour lines */
        z-index: 1;
      }

      .event-title {
        font-weight: bold;
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .event:hover .tooltip {
        display: block;
      }

      /* Tooltip Styling */
      .tooltip {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #000;
        color: #fff;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 10;
        opacity: 0.8;
        display: none;
      }

      /* Meeting Changelog Styling */
      .meeting-changelog {
        margin: 20px 0;
      }

      .meeting-changelog h2 {
        display: flex;
        align-items: center;
      }

      .meeting-tile {
        padding: 10px;
        border-radius: 8px;
        color: #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background-color: #f8f9fa;
        border: 2px solid;
        margin-bottom: 10px;
      }

      .meeting-tile p {
        margin: 5px 0;
      }

      .meeting-tile.unplaceable {
        border-color: #e74c3c;
        position: relative;
      }

      .meeting-tile.unplaceable::after {
        content: "Unplaceable";
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 12px;
        font-weight: bold;
        color: #e74c3c;
      }

      /* Commit Container Styling */
      .commit-container {
        margin: 20px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      .commit-container input[type="text"] {
        width: 90%;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .commit-container button {
        padding: 5px 15px;
        background-color: #3498db;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .commit-container button:hover {
        background-color: #2980b9;
      }

      /* Defrag Logs Styling */
      .defrag-logs {
        background-color: #2c3e50;
        color: #ecf0f1;
        font-family: monospace;
        padding: 15px;
        border-radius: 5px;
        white-space: pre;
        word-wrap: break-word;
        margin-top: 20px;
        overflow: auto;
        max-height: 500px;
        transition: max-height 0.5s ease;
      }

      /* Chevron Styling for Toggle */
      .chevron {
        cursor: pointer;
        margin-right: 10px;
        transition: transform 0.3s ease;
        display: inline-block;
      }
      .chevron.collapsed {
        transform: rotate(0deg);
      }
      .chevron.expanded {
        transform: rotate(90deg);
      }

      /* Selected Event Styling */
      .event.selected {
        outline: 3px solid #2ecc71;
      }

      /* Colored and Greyed Event Styles */
      .colored-event {
        /* Background color is set inline based on moveableMeetingIds */
      }

      .greyed-event {
        background-color: #95a5a6;
        color: #fff;
      }

      /* Loading Screen Styling */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      /* Progress Bar Styling */
      .progress-bar {
        width: 80%;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 20px;
      }

      .progress-bar-fill {
        height: 100%;
        width: 0%;
        background-color: #3498db;
        transition: width 0.5s ease;
      }

      /* Transition for Events */
      .calendar-container-wrapper {
        position: relative;
      }

      .event {
        transition: all 0.5s ease;
      }

      /* Transition for Fading Between Views */
      .fade-enter-active,
      .fade-leave-active {
        transition: all 0.5s ease;
      }
      .fade-enter,
      .fade-leave-to /* .fade-leave-active in <2.1.8 */ {
        opacity: 0;
        transform: translateY(20px);
      }

      /* Warnings Section Styling */
      .warnings-section {
        margin: 20px 0;
      }

      .warnings-section h2 {
        display: flex;
        align-items: center;
        color: #e74c3c;
      }

      .warning-tile {
        padding: 10px;
        border-radius: 8px;
        color: #333;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background-color: #f8f9fa;
        border: 2px solid #e74c3c;
        margin-bottom: 10px;
      }

      .warning-tile p {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Initial Loading Spinner -->
      <div v-if="loading && !isDefragging" class="spinner"></div>

      <!-- Loading Screen with Progress -->
      <div v-if="isDefragging" class="loading-screen">
        <div>Defragmenting your calendar...</div>
        <div>Estimated percentage finished: {{ progress }}%</div>
        <div class="progress-bar">
          <div
            class="progress-bar-fill"
            :style="{ width: progress + '%' }"
          ></div>
        </div>
      </div>

      <!-- Main Content -->
      <div v-else>
        <!-- Initial UI (Date Selector & Meeting Selection) -->
        <div v-if="!defragResult">
          <h2>Defragment Your Calendar</h2>

          <!-- Date Range Selector -->
          <div class="date-selector">
            <label for="week-select"><strong>Select a Week:</strong></label>
            <select
              id="week-select"
              v-model="selectedDate"
              @change="fetchEvents"
            >
              <option
                v-for="(week, index) in weeks"
                :key="week.value + '-' + index"
                :value="week.value"
              >
                {{ week.label }}
              </option>
            </select>
          </div>

          <!-- Explainer Text -->
          <div class="explainer-text">
            Select meetings that you are OK to have moved; unsupported events
            cannot be selected.
          </div>

          <!-- Calendar View for Selecting Moveable Meetings -->
          <div v-if="events.length" class="calendar-container-wrapper">
            <!-- Time Labels -->
            <div class="time-labels">
              <div
                v-for="(hour, index) in timeLabels"
                :key="hour + '-' + index"
                class="time-label"
              >
                {{ hour }}
              </div>
            </div>
            <!-- Calendar Days and Events -->
            <div class="calendar-container">
              <!-- Days Headers -->
              <div
                v-for="day in days"
                :key="day.name"
                class="calendar-day"
                :style="{ borderRight: '1px solid #e0e0e0' }"
              >
                <div class="day-header">{{ day.name }}</div>
              </div>
              <!-- Events Container -->
              <div class="events-container">
                <!-- Render Hour Lines Dynamically -->
                <div
                  v-for="(line, index) in hourLines"
                  :key="index"
                  class="hour-line"
                  :style="{ top: line + 'px' }"
                ></div>
                <!-- Render Events -->
                <transition-group tag="div" name="fade" mode="out-in">
                  <div
                    v-for="event in eventsWithDisplayProps"
                    :key="event.id"
                    class="event"
                    :class="[
                      selectedMeetingIds.includes(event.id) ? 'selected' : '',
                      isMoveable(event.id) ? 'colored-event' : 'greyed-event'
                    ]"
                    :style="getEventStyle(event)"
                    @click="toggleSelection(event.id)"
                  >
                    <div class="event-title">{{ event.summary }}</div>
                    <!-- Tooltip -->
                    <div class="tooltip">
                      {{ formatTime(event.start.dateTime) }} - {{
                      formatTime(event.end.dateTime) }}
                    </div>
                  </div>
                </transition-group>
              </div>
            </div>
          </div>

          <!-- Confirm Button -->
          <div v-if="events.length" style="margin-top: 20px">
            <button
              @click="confirmSelection"
              :disabled="!selectedMeetingIds.length"
            >
              Confirm Selection
            </button>
          </div>
        </div>

        <!-- Calendar Diff View -->
        <div v-if="defragResult" class="calendar-diff">
          <h2>
            Optimized Calendar for {{ formattedSelectedDate }}
            <button
              @mouseover="showOriginalCalendar = true"
              @mouseleave="showOriginalCalendar = false"
              style="margin-left: 20px; padding: 5px 10px; cursor: pointer"
            >
              Hover to show original calendar
            </button>
          </h2>
          <div class="calendar-container-wrapper">
            <!-- Time Labels -->
            <div class="time-labels">
              <div
                v-for="(hour, index) in timeLabels"
                :key="hour + '-' + index"
                class="time-label"
              >
                {{ hour }}
              </div>
            </div>
            <!-- Calendar Days and Events -->
            <div class="calendar-container">
              <!-- Days Headers -->
              <div
                v-for="day in days"
                :key="day.name"
                class="calendar-day"
                :style="{ borderRight: '1px solid #e0e0e0' }"
              >
                <div class="day-header">{{ day.name }}</div>
              </div>
              <!-- Events Container -->
              <div class="events-container">
                <!-- Render Hour Lines Dynamically -->
                <div
                  v-for="(line, index) in hourLines"
                  :key="index"
                  class="hour-line"
                  :style="{ top: line + 'px' }"
                ></div>
                <!-- Render Events -->
                <transition-group tag="div" name="fade" mode="out-in">
                  <div
                    v-for="event in currentEventsWithDisplayProps"
                    :key="event.id"
                    class="event"
                    :class="[
                      isMoveable(event.id) ? 'colored-event' : 'greyed-event'
                    ]"
                    :style="getEventStyle(event)"
                  >
                    <div class="event-title">{{ event.summary }}</div>
                    <!-- Tooltip -->
                    <div class="tooltip">
                      {{ formatTime(event.start.dateTime) }} - {{
                      formatTime(event.end.dateTime) }}
                    </div>
                  </div>
                </transition-group>
              </div>
            </div>
          </div>

          <!-- Meeting Timing Changelog -->
          <div class="meeting-changelog">
            <h2 @click="toggleChangelog" style="cursor: pointer">
              <span
                class="chevron"
                :class="{ collapsed: !changelogVisible, expanded: changelogVisible }"
              >
                &#9654;
              </span>
              Meeting Timing Changelog
            </h2>
            <div v-if="changelogVisible">
              <div
                class="meeting-tile"
                v-for="tile in changelogTiles"
                :key="tile.id + '-' + (tile.unplaceable ? 'unplaceable' : 'placed')"
                :style="{ borderColor: tile.color }"
                :class="{ unplaceable: tile.unplaceable }"
              >
                <p><strong>{{ tile.summary }}</strong></p>
                <p v-if="!tile.unplaceable">Old: {{ tile.oldTime }}</p>
                <p v-if="!tile.unplaceable">New: {{ tile.newTime }}</p>
              </div>
            </div>
          </div>

          <!-- Defrag Logs -->
          <div>
            <h2 @click="toggleLogs" style="cursor: pointer">
              <span
                class="chevron"
                :class="{ collapsed: !logsVisible, expanded: logsVisible }"
              >
                &#9654;
              </span>
              Defrag Command Logs
            </h2>
            <div class="defrag-logs" v-if="logsVisible">
              {{ defragResult.consoleLog }}
            </div>
          </div>

          <!-- Warnings Section -->
          <div class="warnings-section" v-if="warningTiles.length > 0">
            <h2>
              ⚠️ Warning, unplaceable events
              <span
                class="chevron"
                :class="{ collapsed: !warningsVisible, expanded: warningsVisible }"
                @click="toggleWarnings"
                style="margin-left: 10px"
              >
                &#9654;
              </span>
            </h2>
            <div v-if="warningsVisible">
              <div
                class="warning-tile"
                v-for="tile in warningTiles"
                :key="tile.id + '-warning'"
              >
                <p><strong>{{ tile.summary }}</strong></p>
                <p>Time: {{ tile.time }}</p>
              </div>
            </div>
          </div>

          <!-- Commit Changes Section -->
          <div class="commit-container">
            <h2>Commit Changes</h2>
            <input
              type="text"
              v-model="commitMessage"
              placeholder="Enter commit message"
            />
            <button @click="commitChanges" :disabled="!commitMessage">
              Submit Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      new Vue({
        el: "#app",
        data: {
          loading: true, // Indicates if initial data is loading
          isDefragging: false, // Indicates if defragmentation is in progress
          progress: 0, // Progress percentage for defragmentation
          weeks: [], // List of weeks for selection
          selectedDate: "", // Currently selected week date
          events: [], // List of events for the selected week
          moveableMeetingIds: [], // IDs of moveable meetings
          selectedMeetingIds: [], // IDs of currently selected meetings
          days: [
            { name: "Monday" },
            { name: "Tuesday" },
            { name: "Wednesday" },
            { name: "Thursday" },
            { name: "Friday" },
          ], // Days of the week
          timeLabels: [], // Labels for each hour
          hourLines: [], // Positions for each hour line
          calendarHeight: 600, // Height of the calendar in pixels
          defragResult: null, // Result of defragmentation
          commitMessage: "", // Message entered by the user for committing changes
          logsVisible: false, // Indicates if defrag logs are visible
          changelogVisible: false, // Indicates if changelog is visible
          warningsVisible: true, // Warnings section is open by default
          changelogTiles: [], // Tiles for changelog
          warningTiles: [], // Tiles for warnings
          showOriginalCalendar: false, // Toggle to show original calendar
          colorMapping: {}, // Mapping of moveableMeetingIds to colors
          optimizedEvents: [], // List of optimized events after defragmentation
        },
        computed: {
          // Combines starting and solution events based on current view
          eventsWithDisplayProps() {
            return this.events.map((event) => ({
              ...event,
              ...this.calculateDisplayProps(event, "original"),
            }));
          },
          optimizedEventsWithDisplayProps() {
            if (!this.defragResult) return [];
            return this.defragResult.solutionEvents.map((event) => ({
              ...event,
              ...this.calculateDisplayProps(event, "optimized"),
            }));
          },
          currentEventsWithDisplayProps() {
            return this.showOriginalCalendar
              ? this.eventsWithDisplayProps
              : this.optimizedEventsWithDisplayProps;
          },
          formattedSelectedDate() {
            const date = new Date(this.selectedDate);
            return date.toLocaleDateString("en-US", {
              month: "long",
              day: "numeric",
              year: "numeric",
            });
          },
        },
        created() {
          this.initializeWeeks();
          this.fetchInitialData();
        },
        methods: {
          /**
           * Assigns column and totalColumns properties to events based on overlaps.
           * @param {Array} dayEvents - Array of events for a specific day.
           */
          assignOverlaps(dayEvents) {
            // Sort events by start time
            dayEvents.sort(
              (a, b) => new Date(a.start.dateTime) - new Date(b.start.dateTime)
            );

            const columns = [];

            dayEvents.forEach((event) => {
              let placed = false;
              for (let i = 0; i < columns.length; i++) {
                const lastEventInColumn = columns[i][columns[i].length - 1];
                if (
                  new Date(event.start.dateTime) >=
                  new Date(lastEventInColumn.end.dateTime)
                ) {
                  columns[i].push(event);
                  event.column = i;
                  placed = true;
                  break;
                }
              }
              if (!placed) {
                columns.push([event]);
                event.column = columns.length - 1;
              }
            });

            // Assign totalColumns based on actual overlapping counts
            dayEvents.forEach((event, index) => {
              let overlappingCount = 1; // At least the event itself

              dayEvents.forEach((otherEvent, otherIndex) => {
                if (index === otherIndex) return;
                const eventStart = new Date(event.start.dateTime).getTime();
                const eventEnd = new Date(event.end.dateTime).getTime();
                const otherStart = new Date(
                  otherEvent.start.dateTime
                ).getTime();
                const otherEnd = new Date(otherEvent.end.dateTime).getTime();

                // Check if events overlap
                if (eventStart < otherEnd && eventEnd > otherStart) {
                  overlappingCount++;
                }
              });

              event.totalColumns = overlappingCount;
            });
          },
          /**
           * Initializes the weeks for selection based on the current date.
           */
          initializeWeeks() {
            const today = new Date();
            const currentMonday = this.getMonday(today);
            this.weeks = [];

            for (let i = 0; i < 5; i++) {
              const weekDate = new Date(currentMonday);
              weekDate.setDate(currentMonday.getDate() + i * 7);
              const label = `Week of ${weekDate.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
              })}`;
              this.weeks.push({
                value: weekDate.toISOString().split("T")[0],
                label: label,
              });
            }

            // Default to current week
            this.selectedDate = this.weeks[0].value;
          },
          /**
           * Finds the Monday of the week for a given date.
           * @param {Date} d - The date to find the Monday for.
           * @returns {Date} - The Monday of the week.
           */
          getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
            return new Date(d.setDate(diff));
          },
          /**
           * Fetches initial events data for the selected week.
           */
          fetchInitialData() {
            this.fetchEvents();
          },
          /**
           * Fetches events for the selected week from the backend.
           */
          fetchEvents() {
            this.loading = true;
            google.script.run
              .withSuccessHandler((response) => {
                this.events = response.events;
                this.moveableMeetingIds = response.moveableMeetingIds;
                // Select all moveable meetings by default
                this.selectedMeetingIds = [...this.moveableMeetingIds];
                this.assignColors(this.moveableMeetingIds);
                this.calculateOverlaps();
                this.setCalendarBounds();
                this.loading = false;
              })
              .withFailureHandler((error) => {
                console.error(error);
                this.loading = false;
              })
              .getEventsForWeek(this.selectedDate);
          },
          /**
           * Assigns unique colors to moveable meetings.
           * @param {Array} meetingIds - Array of meeting IDs.
           */
          assignColors(meetingIds) {
            this.colorMapping = {};
            meetingIds.forEach((id, index) => {
              const hue = (index * (360 / meetingIds.length)) % 360;
              this.colorMapping[id] = `hsl(${hue}, 70%, 50%)`;
            });
          },
          /**
           * Groups events by day and assigns overlaps.
           */
          calculateOverlaps() {
            const eventsByDay = {};

            // Group events by day
            this.events.forEach((event) => {
              const dayName = this.getDayName(event.start.dateTime);
              if (!eventsByDay[dayName]) {
                eventsByDay[dayName] = [];
              }
              eventsByDay[dayName].push(event);
            });

            // For each day, assign overlaps
            this.days.forEach((day) => {
              const dayEvents = eventsByDay[day.name] || [];
              this.assignOverlaps(dayEvents);
            });
          },

          /**
           * Sets the calendar bounds based on event times and generates time labels and hour lines.
           */
          setCalendarBounds() {
            let earliest = 24;
            let latest = 0;

            this.events.forEach((event) => {
              const start =
                new Date(event.start.dateTime).getHours() +
                new Date(event.start.dateTime).getMinutes() / 60;
              const end =
                new Date(event.end.dateTime).getHours() +
                new Date(event.end.dateTime).getMinutes() / 60;
              if (start < earliest) earliest = start;
              if (end > latest) latest = end;
            });

            // Adjust to nearest whole hour
            earliest = Math.floor(earliest);
            latest = Math.ceil(latest);

            // Generate time labels based on earliest and latest
            this.timeLabels = [];
            for (let hour = earliest; hour <= latest; hour++) {
              const period = hour >= 12 ? "PM" : "AM";
              const displayHour = hour % 12 === 0 ? 12 : hour % 12;
              this.timeLabels.push(`${displayHour}:00 ${period}`);
            }

            // Generate hour lines based on calendarHeight and number of displayed hours
            const totalDisplayedHours = latest - earliest;
            this.hourLines = [];
            const hourHeight = this.calendarHeight / totalDisplayedHours;
            for (let i = 0; i <= totalDisplayedHours; i++) {
              this.hourLines.push(i * hourHeight);
            }

            // Update calendarHeight based on displayed hours
            this.$set(this, "calendarHeight", totalDisplayedHours * hourHeight);
          },
          /**
           * Formats a datetime string to a readable time format.
           * @param {String} dateTime - The datetime string.
           * @returns {String} - Formatted time.
           */
          formatTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
              hour12: true,
            });
          },
          /**
           * Gets the day name from a datetime string.
           * @param {String} dateTime - The datetime string.
           * @returns {String} - Day name (e.g., Monday).
           */
          getDayName(dateTime) {
            const date = new Date(dateTime);
            const options = { weekday: "long" };
            return date.toLocaleDateString("en-US", options);
          },
          /**
           * Calculates the style for an event based on its time and overlap properties.
           * @param {Object} event - The event object.
           * @returns {Object} - Style object.
           */
          getEventStyle(event) {
            const startDate = new Date(event.start.dateTime);
            const endDate = new Date(event.end.dateTime);
            const durationHours = (endDate - startDate) / (1000 * 60 * 60);
            const earliestHour = Math.floor(
              parseInt(this.timeLabels[0].split(":")[0], 10)
            );
            const top =
              (startDate.getHours() +
                startDate.getMinutes() / 60 -
                earliestHour) *
              (this.calendarHeight / (this.timeLabels.length - 1));
            const height =
              Math.max(
                durationHours *
                  (this.calendarHeight / (this.timeLabels.length - 1)),
                20
              ) - 3;

            // Calculate width and left based on overlapping columns relative to day width
            const totalColumns = event.totalColumns || 1;
            const column = event.column || 0;
            const dayWidthPercent = 100 / this.days.length;

            // Adjust 'left' to be relative to the day's width
            const left =
              totalColumns > 0 ? (column * dayWidthPercent) / totalColumns : 0;
            const eventLeft =
              this.days.findIndex(
                (day) => day.name === this.getDayName(event.start.dateTime)
              ) *
                dayWidthPercent +
              left;

            // Adjust 'width' to be relative to the day's width
            const width =
              totalColumns > 0
                ? dayWidthPercent / totalColumns - 0.3
                : dayWidthPercent - 0.3;

            return {
              top: `${top}px`,
              height: `${height}px`,
              backgroundColor: this.isMoveable(event.id)
                ? this.colorMapping[event.id]
                : "#95a5a6", // Grey for non-moveable
              cursor: this.isMoveable(event.id) ? "pointer" : "not-allowed",
              opacity: this.isMoveable(event.id) ? 1 : 0.5,
              left: `${eventLeft}%`,
              width: `${width}%`,
              position: "absolute",
              /* Transition for smooth movement */
              transition: "all 0.5s ease",
              pointerEvents: this.isMoveable(event.id) ? "auto" : "none", // Allow clicking only on moveable events
            };
          },

          /**
           * Toggles the selection of a meeting.
           * @param {String} eventId - The ID of the event.
           */
          toggleSelection(eventId) {
            if (!this.isMoveable(eventId)) return;

            const index = this.selectedMeetingIds.indexOf(eventId);
            if (index > -1) {
              this.selectedMeetingIds.splice(index, 1);
            } else {
              this.selectedMeetingIds.push(eventId);
            }
          },
          /**
           * Confirms the selection of meetings and initiates defragmentation.
           */
          confirmSelection() {
            if (!this.selectedMeetingIds.length) return;
            this.isDefragging = true;
            this.progress = 0;
            this.loading = false;

            // Start progress simulation
            const progressInterval = setInterval(() => {
              if (this.progress < 100) {
                this.progress += 10;
              } else {
                clearInterval(progressInterval);
              }
            }, 3000); // Update every 3 seconds for 30 seconds total

            // Call backend defrag
            google.script.run
              .withSuccessHandler((response) => {
                clearInterval(progressInterval);
                this.defragResult = response;
                this.prepareChangelog();
                this.assignColors(this.defragResult.moveableMeetingIds);
                this.calculateOverlapsOptimized();
                this.setCalendarBounds();
                this.loading = false;
                this.isDefragging = false;
              })
              .withFailureHandler((error) => {
                console.error(error);
                clearInterval(progressInterval);
                this.loading = false;
                this.isDefragging = false;
              })
              .defrag(this.selectedDate, this.selectedMeetingIds);
          },
          /**
           * Calculates overlaps for optimized events after defragmentation.
           */
          calculateOverlapsOptimized() {
            if (!this.defragResult) return;

            const eventsByDay = {};

            // Group optimized events by day
            this.defragResult.solutionEvents.forEach((event) => {
              const dayName = this.getDayName(event.start.dateTime);
              if (!eventsByDay[dayName]) {
                eventsByDay[dayName] = [];
              }
              eventsByDay[dayName].push(event);
            });

            // For each day, assign overlaps using the helper function
            this.days.forEach((day) => {
              const dayEvents = eventsByDay[day.name] || [];
              this.assignOverlaps(dayEvents);
            });
          },
          /**
           * Commits the defragmentation changes with a commit message.
           */
          commitChanges() {
            if (!this.defragResult) return;
            this.loading = true;
            google.script.run
              .withSuccessHandler((response) => {
                alert("Changes committed successfully!");
                this.resetState();
                this.loading = false;
              })
              .withFailureHandler((error) => {
                console.error(error);
                this.loading = false;
              })
              .commitDefrag(this.commitMessage, this.defragResult);
          },
          /**
           * Resets the application state after committing changes.
           */
          resetState() {
            this.defragResult = null;
            this.commitMessage = "";
            this.selectedMeetingIds = [];
            this.events = [];
            this.moveableMeetingIds = [];
            this.days.forEach((day) => {
              day.events = [];
            });
            this.colorMapping = {};
            this.changelogTiles = [];
            this.warningTiles = [];
          },
          /**
           * Toggles the visibility of defrag logs.
           */
          toggleLogs() {
            this.logsVisible = !this.logsVisible;
          },
          /**
           * Toggles the visibility of the changelog section.
           */
          toggleChangelog() {
            this.changelogVisible = !this.changelogVisible;
          },
          /**
           * Toggles the visibility of the warnings section.
           */
          toggleWarnings() {
            this.warningsVisible = !this.warningsVisible;
          },
          /**
           * Prepares the changelog and warnings based on defragmentation results.
           */
          prepareChangelog() {
            if (!this.defragResult) return;
            this.changelogTiles = [];
            this.warningTiles = [];

            // Changelog for moveable meetings
            this.defragResult.moveableMeetingIds.forEach((id) => {
              const startingEvent = this.defragResult.startingEvents.find(
                (event) => event.id === id
              );
              const solutionEvent = this.defragResult.solutionEvents.find(
                (event) => event.id === id
              );

              if (startingEvent && solutionEvent) {
                const oldStart = new Date(
                  startingEvent.start.dateTime
                ).toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: true,
                });
                const oldEnd = new Date(
                  startingEvent.end.dateTime
                ).toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: true,
                });
                const newStart = new Date(
                  solutionEvent.start.dateTime
                ).toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: true,
                });
                const newEnd = new Date(
                  solutionEvent.end.dateTime
                ).toLocaleTimeString("en-US", {
                  hour: "2-digit",
                  minute: "2-digit",
                  hour12: true,
                });

                this.changelogTiles.push({
                  id: id,
                  summary: startingEvent.summary,
                  oldTime: `${oldStart} - ${oldEnd}`,
                  newTime: `${newStart} - ${newEnd}`,
                  color: this.colorMapping[id],
                  unplaceable: false,
                });
              }
            });

            // Changelog for unplaceable meetings moved to Warnings
            this.defragResult.unplaceableMeetingIds.forEach((id) => {
              const event = this.defragResult.startingEvents.find(
                (e) => e.id === id
              );
              if (event) {
                const time =
                  this.formatTime(event.start.dateTime) +
                  " - " +
                  this.formatTime(event.end.dateTime);

                this.warningTiles.push({
                  id: id,
                  summary: event.summary,
                  time: time,
                });
              }
            });
          },
          /**
           * Calculates additional display properties for events based on the view type.
           * @param {Object} event - The event object.
           * @param {String} viewType - The type of view ("original" or "optimized").
           * @returns {Object} - Additional display properties.
           */
          calculateDisplayProps(event, viewType) {
            // This function can be expanded if different display properties are needed based on the view type
            // Currently, it returns the same properties for both 'original' and 'optimized' views
            return {
              // Additional properties can be calculated here if needed
            };
          },
          /**
           * Determines if an event is moveable based on the current view.
           * @param {String} eventId - The ID of the event.
           * @returns {Boolean} - True if the event is moveable, else false.
           */
          isMoveable(eventId) {
            if (this.defragResult) {
              return this.defragResult.moveableMeetingIds.includes(eventId);
            }
            return this.moveableMeetingIds.includes(eventId);
          },
        },
      });
    </script>
  </body>
</html>
