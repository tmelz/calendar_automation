<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìÖ Calendar Automation by @tmellor ‚ö°Ô∏è</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        color: #333;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      .read-only-text {
        padding: 8px;
        border: 1px solid transparent;
        border-radius: 4px;
        background-color: #f8f9fa;
      }
      .read-only-text:hover {
        background-color: #e9ecef;
      }
      .color-button {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        margin-right: 5px;
        padding: 0;
        position: relative;
      }
      .color-button.selected {
        border: 5px solid cyan;
      }
      .color-button.no-op {
        background-color: transparent;
      }
      .color-button.no-op::after {
        content: "üö´";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
      }
      .color-button.trash-emoji {
        background-color: transparent;
      }
      .color-button.trash-emoji::after {
        content: "üóëÔ∏è";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 16px;
      }
      .color-subsection {
        margin-top: 15px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #f1f3f5;
      }
      .color-options {
        display: flex;
        flex-wrap: wrap;
      }
      .btn-color {
        display: inline-block;
      }
      .team-calendar-section {
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #f1f3f5;
        margin-bottom: 15px;
      }
      .mb-1 {
        margin-bottom: 5px !important;
      }
      .btn-action {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }
      .btn-action i {
        pointer-events: none;
      }
      /* Ensure spans are inline-block for tooltips */
      .tooltip-wrapper {
        display: inline-block;
      }
      .calendar-entry {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 10px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .calendar-entry:hover {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      }
      .calendar-entry.saved {
        background-color: #f1f3f5;
      }
      .calendar-entry.new {
        background-color: #fff;
        border: 1px dashed #adb5bd;
      }
      .section-header {
        margin-bottom: 15px;
        font-weight: 500;
      }
      .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      /* Saving indicator styles */
      .saving-indicator {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        background-color: #cfe2ff;
        color: #084298;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
        max-width: 200px;
      }
      .saved-indicator {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1050;
        background-color: #d1e7dd;
        color: #0f5132;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
        max-width: 200px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1 class="mb-3">üìÖ Calendar Automation ‚ö°Ô∏è</h1>
      <p class="text-muted">by @tmellor</p>

      <div class="alert alert-warning" role="alert">
        ‚ö†Ô∏è This tool will modify your calendar. It is tested, but proceed at
        your own risk.
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="h5 mb-0">Settings ‚öôÔ∏è</h2>
        </div>
        <div class="card-body">
          <!-- Global Settings -->
          <div class="mb-4">
            <h5>Global Settings</h5>
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="enableAutomation"
                v-model="settings.enabled"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="enableAutomation">
                Enable Calendar Automation (disabling this disables all
                features)
              </label>
              <div class="form-text">
                Note you can disable the automation for a specific event by
                adding "[opt_out_automation]" to the event description.
              </div>
            </div>
          </div>

          <!-- 1-on-1-only Feature Settings -->
          <fieldset :disabled="!settings.enabled" class="mb-4">
            <h5>1-on-1-only Feature Settings</h5>
            <div class="form-check mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                id="outOfOffice"
                v-model="settings.checks.outOfOffice"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="outOfOffice">
                Attendee Out of Office Indicator
              </label>
              <div class="form-text">
                Add a üö® to meeting titles where an attendee is out of office.
              </div>
            </div>
            <div class="form-check mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                id="conflict"
                v-model="settings.checks.conflict"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="conflict"> Conflict </label>
              <div class="form-text">
                Add a ‚öîÔ∏è to the meeting title if an attendee is RSVPd to another
                event at the same time.
              </div>
            </div>
            <div class="form-check mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                id="quit"
                v-model="settings.checks.quit"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="quit"> Quit </label>
              <div class="form-text">
                Add a üëª to the meeting title if an attendee is no longer an
                employee.
              </div>
            </div>
            <div class="form-check mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                id="notes"
                v-model="settings.checks.notes"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="notes">
                [Experimental] Auto add recurring notes doc for adhoc 1:1s
              </label>
              <div class="form-text">
                When an adhoc 1:1 is created, look to see if there's a recurring
                1:1 with this person that has a notes doc attached. If so, auto
                attach that doc to the adhoc meeting.
              </div>
            </div>
          </fieldset>

          <!-- Features for All Events -->
          <fieldset :disabled="!settings.enabled" class="mb-4">
            <h5>Features for All Events</h5>
            <div class="form-check mb-1">
              <input
                class="form-check-input"
                type="checkbox"
                id="plusFiveMinutes"
                v-model="settings.checks.plusFiveMinutes"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="plusFiveMinutes">
                Start meetings +5m
              </label>
              <div class="form-text">
                Start meetings 5m after the hour or half hour. This high level
                setting unblocks the sub settings below, it has no effect if all
                sub settings are disabled. Note you can opt out a specific event
                by adding "[opt_out_plus5m]" to the event description.
              </div>
            </div>
            <div v-if="settings.checks.plusFiveMinutes" class="ms-3">
              <div class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="plusFiveMinutesOneOnOnes"
                  v-model="settings.checkSettings.plusFiveMinutes.oneOnOnes"
                  @change="onSettingsChanged"
                />
                <label class="form-check-label" for="plusFiveMinutesOneOnOnes">
                  For 1-on-1 meetings
                </label>
              </div>
              <div class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="plusFiveMinutesAnyEvent"
                  v-model="settings.checkSettings.plusFiveMinutes.anyEventIOrganizeOrCreateWithAttendees"
                  @change="onSettingsChanged"
                />
                <label class="form-check-label" for="plusFiveMinutesAnyEvent">
                  For any event I organize or create (with attendees, excludes
                  calendar holds)
                </label>
              </div>
            </div>
            <!-- Event Color Setting -->
            <div
              class="d-flex justify-content-between align-items-center mb-1 mt-3"
            >
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="eventColorToggle"
                  v-model="settings.checks.eventColor"
                  @change="onSettingsChanged"
                />
                <label class="form-check-label" for="eventColorToggle">
                  Event Color
                </label>
                <div class="form-text">
                  Enable event color coding based on categories.
                </div>
              </div>
              <button
                class="btn btn-secondary btn-sm"
                type="button"
                @click="toggleColorOptions"
                :disabled="!settings.checks.eventColor"
              >
                Toggle Color Options
              </button>
            </div>
            <div
              v-if="settings.checks.eventColor && showColorOptions"
              class="color-subsection"
              id="eventColorOptions"
            >
              <div class="mt-3">
                <div
                  v-for="category in orderedCategories"
                  :key="category"
                  class="d-flex align-items-center mb-1"
                >
                  <label class="me-3 mb-0" style="width: 200px">
                    {{ category }}
                  </label>
                  <div class="color-options">
                    <button
                      v-for="colorOption in colorOptions"
                      :key="colorOption"
                      type="button"
                      class="color-button"
                      :class="{ 
                        'no-op': colorOption === 'No-op',
                        'trash-emoji': colorOption === 'Delete',
                        selected: settings.checkSettings.eventColors[category] === colorOption
                      }"
                      :style="{ backgroundColor: colorOption === 'Delete' ? 'transparent' : colorHexMap[colorOption] }"
                      @click="selectColor(category, colorOption)"
                      :title="colorOption === 'No-op' ? 'No-op, do not modify any existing color. See related option \'delete\', which will remove any existing color' : colorOption === 'Delete' ? 'Remove color (thus using calendar default)' : colorOption"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                    >
                      <span v-if="colorOption === 'No-op'"></span>
                      <span v-else-if="colorOption === 'Delete'"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </fieldset>

          <!-- Features for Team Calendars -->
          <fieldset :disabled="!settings.enabled" class="mb-4">
            <h5>Features for Team Calendars</h5>

            <!-- Out of Office Team Calendars -->
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="teamOutOfOffice"
                v-model="settings.teamCalendar.outOfOffice"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="teamOutOfOffice">
                Enable Out of Office for Team Calendars
              </label>
              <div class="form-text">
                Add team member's OOO events onto the team calendar.
              </div>
            </div>

            <div
              v-if="settings.teamCalendar.outOfOffice"
              class="team-calendar-section"
            >
              <h6 class="mb-3">Out of Office Team Calendars</h6>

              <div
                v-for="(entry, index) in settings.teamCalendarSettings.outOfOffice"
                :key="'ooo-' + index"
                class="calendar-entry"
                :class="{ 'saved': !entry.editing, 'new': entry.editing }"
              >
                <div class="row">
                  <div class="col-md-5 mb-2">
                    <label class="form-label">Calendar ID</label>
                    <input
                      type="text"
                      class="form-control"
                      v-model="entry.calendarId"
                      @input="validateCalendarId(index)"
                      :class="{ 'is-invalid': validationErrors[index].calendarId }"
                      placeholder="your-calendar@group.calendar.google.com"
                    />
                    <div class="invalid-feedback">
                      Calendar ID must end with @group.calendar.google.com
                    </div>
                  </div>

                  <div class="col-md-5 mb-2">
                    <label class="form-label">Group Email</label>
                    <input
                      type="email"
                      class="form-control"
                      v-model="entry.groupEmail"
                      @input="validateGroupEmail(index)"
                      :class="{ 'is-invalid': validationErrors[index].groupEmail }"
                      placeholder="group@example.com"
                    />
                    <div class="invalid-feedback">
                      Please enter a valid email address.
                    </div>
                  </div>

                  <div
                    class="col-md-2 d-flex align-items-end justify-content-end mb-2"
                  >
                    <button
                      v-if="entry.editing && canSave(index)"
                      type="button"
                      class="btn btn-success me-2"
                      @click="saveEntry(index)"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Save"
                    >
                      <i class="bi bi-check"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      @click="removeTeamCalendarEntry(index, $event)"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Delete"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>

              <button
                type="button"
                class="btn btn-primary mt-2"
                @click="addTeamCalendarEntry"
              >
                <i class="bi bi-plus-circle"></i> Add Team Calendar
              </button>
            </div>

            <!-- Oncall Team Calendars -->
            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="teamOncall"
                v-model="settings.teamCalendar.oncall"
                @change="onSettingsChanged"
              />
              <label class="form-check-label" for="teamOncall">
                Enable Oncall for Team Calendars
              </label>
              <div class="form-text">
                Add oncall schedule events onto the team calendar.
              </div>
            </div>

            <div
              v-if="settings.teamCalendar.oncall"
              class="team-calendar-section"
            >
              <h6 class="mb-3">Oncall Team Calendars</h6>

              <div
                v-for="(entry, index) in settings.teamCalendarSettings.oncall"
                :key="'oncall-' + index"
                class="calendar-entry"
                :class="{ 'saved': !entry.editing, 'new': entry.editing }"
              >
                <div class="row">
                  <div class="col-md-5 mb-2">
                    <label class="form-label">Calendar ID</label>
                    <input
                      type="text"
                      class="form-control"
                      v-model="entry.calendarId"
                      @input="validateOncallCalendarId(index)"
                      :class="{ 'is-invalid': validationErrorsOncall[index].calendarId }"
                      placeholder="your-calendar@group.calendar.google.com"
                    />
                    <div class="invalid-feedback">
                      Calendar ID must end with @group.calendar.google.com
                    </div>
                  </div>

                  <div class="col-md-5 mb-2">
                    <label class="form-label">Oncall Schedule ID</label>
                    <input
                      type="text"
                      class="form-control"
                      v-model="entry.scheduleId"
                      @input="validateScheduleId(index)"
                      :class="{ 'is-invalid': validationErrorsOncall[index].scheduleId }"
                      placeholder="Oncall Schedule ID"
                    />
                    <div class="invalid-feedback">
                      Please enter a valid schedule ID.
                    </div>
                  </div>

                  <div
                    class="col-md-2 d-flex align-items-end justify-content-end mb-2"
                  >
                    <button
                      v-if="entry.editing && canSaveOncall(index)"
                      type="button"
                      class="btn btn-success me-2"
                      @click="saveOncallEntry(index)"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Save"
                    >
                      <i class="bi bi-check"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      @click="removeOncallEntry(index, $event)"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Delete"
                    >
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>

              <button
                type="button"
                class="btn btn-primary mt-2"
                @click="addOncallEntry"
              >
                <i class="bi bi-plus-circle"></i> Add Team Calendar
              </button>
            </div>
          </fieldset>
        </div>
      </div>

      <!-- Saving and Saved Indicators -->
      <div v-if="saving" class="saving-indicator">
        Saving<span>{{ ellipsis }}</span>
      </div>
      <div v-if="saved" class="saved-indicator">Saved &#x2705;</div>
    </div>

    <!-- User Settings Script -->
    <script>
      const userSettings = <?!= JSON.stringify(userSettings) ?> || {
        enabled: false,
        checks: {
          plusFiveMinutes: false,
          outOfOffice: false,
          conflict: false,
          quit: false,
          eventColor: false,
          notes: false,
        },
        checkSettings: {
          eventColors: {
            "External attendees": "No-op",
            "One-on-one": "No-op",
            "Focus Time": "No-op",
            Hold: "No-op",
            "Team sync": "No-op",
            "Ad-hoc": "No-op",
            "Out of office": "No-op",
            "Other": "No-op",
          },
          plusFiveMinutes: {
            oneOnOnes: false,
            anyEventIOrganizeOrCreateWithAttendees: false,
          },
        },
        teamCalendar: {
          outOfOffice: false,
          oncall: false,
        },
        teamCalendarSettings: {
          outOfOffice: [],
          oncall: [],
        },
      };
      console.log("User settings object:", userSettings);
    </script>

    <!-- Vue.js Application -->
    <script>
      new Vue({
        el: "#app",
        data: {
          settings: {
            enabled: false,
            checks: {
              plusFiveMinutes: false,
              outOfOffice: false,
              conflict: false,
              quit: false,
              eventColor: false,
              notes: false,
            },
            checkSettings: {
              eventColors: {
                "External attendees": "No-op",
                "One-on-one": "No-op",
                "Focus Time": "No-op",
                Hold: "No-op",
                "Team sync": "No-op",
                "Ad-hoc": "No-op",
                "Out of office": "No-op",
                Other: "No-op",
              },
              plusFiveMinutes: {
                oneOnOnes: false,
                anyEventIOrganizeWithAttendees: false,
              },
            },
            teamCalendar: {
              outOfOffice: false,
              oncall: false,
            },
            teamCalendarSettings: {
              outOfOffice: [],
              oncall: [],
            },
          },
          saving: false,
          saved: false,
          ellipsis: "",
          colorOptions: [
            "No-op",
            "Delete",
            "Lavender",
            "Sage",
            "Grape",
            "Flamingo",
            "Banana",
            "Tangerine",
            "Peacock",
            "Graphite",
            "Blueberry",
            "Basil",
            "Tomato",
          ],
          orderedCategories: [
            "External attendees",
            "One-on-one",
            "Focus Time",
            "Hold",
            "Team sync",
            "Ad-hoc",
            "Out of office",
            "Other",
          ],
          validationErrors: [],
          originalEntries: [],
          // New arrays for Oncall validation and originals
          validationErrorsOncall: [],
          originalEntriesOncall: [],
          showColorOptions: true,
          // https://google-calendar-simple-api.readthedocs.io/en/latest/colors.html
          colorHexMap: {
            "No-op": "transparent",
            Delete: "transparent",
            Lavender: "#7986CB",
            Sage: "#33B679",
            Grape: "#8E24AA",
            Flamingo: "#E67C73",
            Banana: "#F6BF26",
            Tangerine: "#F4511E",
            Peacock: "#039BE5",
            Graphite: "#616161",
            Blueberry: "#3F51B5",
            Basil: "#0B8043",
            Tomato: "#D50000",
          },
        },
        created() {
          // Merge userSettings into settings
          this.settings.enabled = userSettings.enabled;
          this.settings.checks = Object.assign(
            {},
            this.settings.checks,
            userSettings.checks
          );
          this.settings.checkSettings.eventColors = Object.assign(
            {},
            this.settings.checkSettings.eventColors,
            userSettings.checkSettings.eventColors
          );
          if (userSettings.checkSettings.plusFiveMinutes) {
            this.settings.checkSettings.plusFiveMinutes = Object.assign(
              {},
              this.settings.checkSettings.plusFiveMinutes,
              userSettings.checkSettings.plusFiveMinutes
            );
          }
          this.settings.teamCalendar = Object.assign(
            {},
            this.settings.teamCalendar,
            userSettings.teamCalendar
          );
          this.settings.teamCalendarSettings.outOfOffice =
            userSettings.teamCalendarSettings &&
            userSettings.teamCalendarSettings.outOfOffice
              ? userSettings.teamCalendarSettings.outOfOffice.map((entry) => ({
                  calendarId: entry.calendarId || "",
                  groupEmail: entry.groupEmail || "",
                  editing: false,
                }))
              : [];
          this.settings.teamCalendarSettings.oncall =
            userSettings.teamCalendarSettings &&
            userSettings.teamCalendarSettings.oncall
              ? userSettings.teamCalendarSettings.oncall.map((entry) => ({
                  calendarId: entry.calendarId || "",
                  scheduleId: entry.scheduleId || "",
                  editing: false,
                }))
              : [];

          // Initialize validationErrors array based on existing outOfOffice entries
          this.validationErrors =
            this.settings.teamCalendarSettings.outOfOffice.map(() => ({
              calendarId: false,
              groupEmail: false,
            }));
          // Initialize originalEntries for outOfOffice cancel functionality
          this.originalEntries =
            this.settings.teamCalendarSettings.outOfOffice.map((entry) => ({
              calendarId: entry.calendarId,
              groupEmail: entry.groupEmail,
            }));

          // Initialize validationErrors and originalEntries for oncall entries
          this.validationErrorsOncall =
            this.settings.teamCalendarSettings.oncall.map(() => ({
              calendarId: false,
              scheduleId: false,
            }));
          this.originalEntriesOncall =
            this.settings.teamCalendarSettings.oncall.map((entry) => ({
              calendarId: entry.calendarId,
              scheduleId: entry.scheduleId,
            }));
        },
        mounted() {
          // Initialize Bootstrap tooltips
          this.initializeTooltips();
        },
        methods: {
          initializeTooltips() {
            this.$nextTick(() => {
              const tooltipTriggerList = [].slice.call(
                document.querySelectorAll('[data-bs-toggle="tooltip"]')
              );
              tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                const tooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if (tooltip) {
                  tooltip.dispose();
                }
                new bootstrap.Tooltip(tooltipTriggerEl, {
                  trigger: "hover focus",
                  boundary: "window",
                });
              });
            });
          },
          onSettingsChanged() {
            if (this.saving) return;

            // Validate all team calendar outOfOffice entries before saving
            let hasErrors = false;
            this.validationErrors =
              this.settings.teamCalendarSettings.outOfOffice.map(
                (entry, index) => {
                  const errors = { calendarId: false, groupEmail: false };
                  if (this.settings.teamCalendar.outOfOffice) {
                    if (
                      entry.calendarId.trim() !== "" ||
                      entry.groupEmail.trim() !== ""
                    ) {
                      if (
                        !entry.calendarId ||
                        !entry.calendarId.endsWith("@group.calendar.google.com")
                      ) {
                        errors.calendarId = true;
                        hasErrors = true;
                      }
                      const emailPattern =
                        /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;
                      if (
                        !entry.groupEmail ||
                        !emailPattern.test(entry.groupEmail)
                      ) {
                        errors.groupEmail = true;
                        hasErrors = true;
                      }
                    }
                  }
                  return errors;
                }
              );

            // Validate all team calendar oncall entries before saving
            this.validationErrorsOncall =
              this.settings.teamCalendarSettings.oncall.map((entry, index) => {
                const errors = { calendarId: false, scheduleId: false };
                if (this.settings.teamCalendar.oncall) {
                  if (
                    entry.calendarId.trim() !== "" ||
                    entry.scheduleId.trim() !== ""
                  ) {
                    if (
                      !entry.calendarId ||
                      !entry.calendarId.endsWith("@group.calendar.google.com")
                    ) {
                      errors.calendarId = true;
                      hasErrors = true;
                    }
                    if (!entry.scheduleId || entry.scheduleId.trim() === "") {
                      errors.scheduleId = true;
                      hasErrors = true;
                    }
                  }
                }
                return errors;
              });

            // Check for validation errors
            if (hasErrors) {
              alert(
                "Please fix validation errors before saving your settings."
              );
              return;
            }

            // Filter out empty outOfOffice entries (both fields empty)
            const filteredOutOfOfficeSettings =
              this.settings.teamCalendarSettings.outOfOffice
                .filter(
                  (entry) =>
                    entry.calendarId.trim() !== "" &&
                    entry.groupEmail.trim() !== ""
                )
                .map((entry) => ({
                  calendarId: entry.calendarId,
                  groupEmail: entry.groupEmail,
                }));

            // Filter out empty oncall entries (both fields empty)
            const filteredOncallSettings =
              this.settings.teamCalendarSettings.oncall
                .filter(
                  (entry) =>
                    entry.calendarId.trim() !== "" &&
                    entry.scheduleId.trim() !== ""
                )
                .map((entry) => ({
                  calendarId: entry.calendarId,
                  scheduleId: entry.scheduleId,
                }));

            // Prepare the settings object to save
            const settingsToSave = {
              enabled: this.settings.enabled,
              checks: this.settings.checks,
              checkSettings: {
                eventColors: this.settings.checkSettings.eventColors,
                plusFiveMinutes: this.settings.checkSettings.plusFiveMinutes,
              },
              teamCalendar: this.settings.teamCalendar,
              teamCalendarSettings: {
                outOfOffice: filteredOutOfOfficeSettings,
                oncall: filteredOncallSettings,
              },
            };

            this.saving = true;
            this.saved = false;
            this.animateEllipsis();

            // Call the Google Apps Script backend method
            google.script.run
              .withSuccessHandler(() => {
                this.saving = false;
                this.saved = true;
                this.fadeOutSavedMessage();
                this.initializeTooltips();
              })
              .withFailureHandler((error) => {
                this.saving = false;
                alert("Error saving settings. Please try again.");
                console.error("Save settings error:", error);
              })
              .onSettingsChanged(settingsToSave);
          },
          animateEllipsis() {
            let count = 0;
            const interval = setInterval(() => {
              if (!this.saving) {
                clearInterval(interval);
                this.ellipsis = "";
                return;
              }
              count = (count + 1) % 4;
              this.ellipsis = ".".repeat(count);
            }, 500);
          },
          fadeOutSavedMessage() {
            setTimeout(() => {
              this.saved = false;
            }, 2000);
          },
          addTeamCalendarEntry() {
            this.settings.teamCalendarSettings.outOfOffice.push({
              calendarId: "",
              groupEmail: "",
              editing: true,
            });
            this.validationErrors.push({
              calendarId: false,
              groupEmail: false,
            });
            this.originalEntries.push({
              calendarId: "",
              groupEmail: "",
            });

            this.$nextTick(() => {
              this.initializeTooltips();
            });
          },
          saveEntry(index) {
            const entry = this.settings.teamCalendarSettings.outOfOffice[index];
            this.validateCalendarId(index);
            this.validateGroupEmail(index);
            if (
              this.validationErrors[index].calendarId ||
              this.validationErrors[index].groupEmail
            ) {
              alert("Please fix validation errors before saving.");
              return;
            }
            this.settings.teamCalendarSettings.outOfOffice[index].editing =
              false;
            this.originalEntries[index] = {
              calendarId: entry.calendarId,
              groupEmail: entry.groupEmail,
            };
            this.onSettingsChanged();

            this.$nextTick(() => {
              this.initializeTooltips();
            });
          },
          cancelEdit(index) {
            const original = this.originalEntries[index];
            this.settings.teamCalendarSettings.outOfOffice[index].calendarId =
              original.calendarId;
            this.settings.teamCalendarSettings.outOfOffice[index].groupEmail =
              original.groupEmail;
            this.settings.teamCalendarSettings.outOfOffice[index].editing =
              false;
            this.validationErrors[index] = {
              calendarId: false,
              groupEmail: false,
            };

            this.$nextTick(() => {
              this.initializeTooltips();
            });
          },
          removeTeamCalendarEntry(index, event) {
            const span = event.currentTarget.parentElement;
            const tooltip = bootstrap.Tooltip.getInstance(span);
            if (tooltip) {
              tooltip.hide();
            }

            if (confirm("Are you sure you want to delete this entry?")) {
              this.settings.teamCalendarSettings.outOfOffice.splice(index, 1);
              this.validationErrors.splice(index, 1);
              this.originalEntries.splice(index, 1);
              this.onSettingsChanged();

              this.$nextTick(() => {
                this.initializeTooltips();
              });
            }
          },
          validateCalendarId(index) {
            const entry = this.settings.teamCalendarSettings.outOfOffice[index];
            if (
              entry.calendarId &&
              entry.calendarId.endsWith("@group.calendar.google.com")
            ) {
              this.validationErrors[index].calendarId = false;
            } else if (
              entry.calendarId.trim() === "" &&
              entry.groupEmail.trim() === ""
            ) {
              this.validationErrors[index].calendarId = false;
            } else {
              this.validationErrors[index].calendarId = true;
            }
          },
          validateGroupEmail(index) {
            const entry = this.settings.teamCalendarSettings.outOfOffice[index];
            const emailPattern =
              /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;
            if (entry.groupEmail && emailPattern.test(entry.groupEmail)) {
              this.validationErrors[index].groupEmail = false;
            } else if (
              entry.calendarId.trim() === "" &&
              entry.groupEmail.trim() === ""
            ) {
              this.validationErrors[index].groupEmail = false;
            } else {
              this.validationErrors[index].groupEmail = true;
            }
          },
          canSave(index) {
            return (
              this.settings.teamCalendarSettings.outOfOffice[
                index
              ].calendarId.trim() !== "" &&
              this.settings.teamCalendarSettings.outOfOffice[
                index
              ].groupEmail.trim() !== "" &&
              !this.validationErrors[index].calendarId &&
              !this.validationErrors[index].groupEmail &&
              this.settings.enabled
            );
          },
          hasChanges(index) {
            const current =
              this.settings.teamCalendarSettings.outOfOffice[index];
            const original = this.originalEntries[index];
            return (
              current.calendarId !== original.calendarId ||
              current.groupEmail !== original.groupEmail
            );
          },
          // Methods for Oncall entries
          validateOncallCalendarId(index) {
            const entry = this.settings.teamCalendarSettings.oncall[index];
            if (
              entry.calendarId &&
              entry.calendarId.endsWith("@group.calendar.google.com")
            ) {
              this.validationErrorsOncall[index].calendarId = false;
            } else if (
              entry.calendarId.trim() === "" &&
              entry.scheduleId.trim() === ""
            ) {
              this.validationErrorsOncall[index].calendarId = false;
            } else {
              this.validationErrorsOncall[index].calendarId = true;
            }
          },
          validateScheduleId(index) {
            const entry = this.settings.teamCalendarSettings.oncall[index];
            if (entry.scheduleId && entry.scheduleId.trim() !== "") {
              this.validationErrorsOncall[index].scheduleId = false;
            } else if (
              entry.calendarId.trim() === "" &&
              entry.scheduleId.trim() === ""
            ) {
              this.validationErrorsOncall[index].scheduleId = false;
            } else {
              this.validationErrorsOncall[index].scheduleId = true;
            }
          },
          addOncallEntry() {
            this.settings.teamCalendarSettings.oncall.push({
              calendarId: "",
              scheduleId: "",
              editing: true,
            });
            this.validationErrorsOncall.push({
              calendarId: false,
              scheduleId: false,
            });
            this.originalEntriesOncall.push({
              calendarId: "",
              scheduleId: "",
            });
            this.$nextTick(() => {
              this.initializeTooltips();
            });
          },
          saveOncallEntry(index) {
            const entry = this.settings.teamCalendarSettings.oncall[index];
            this.validateOncallCalendarId(index);
            this.validateScheduleId(index);
            if (
              this.validationErrorsOncall[index].calendarId ||
              this.validationErrorsOncall[index].scheduleId
            ) {
              alert("Please fix validation errors before saving.");
              return;
            }
            this.settings.teamCalendarSettings.oncall[index].editing = false;
            this.originalEntriesOncall[index] = {
              calendarId: entry.calendarId,
              scheduleId: entry.scheduleId,
            };
            this.onSettingsChanged();
            this.$nextTick(() => {
              this.initializeTooltips();
            });
          },
          cancelOncallEdit(index) {
            const original = this.originalEntriesOncall[index];
            this.settings.teamCalendarSettings.oncall[index].calendarId =
              original.calendarId;
            this.settings.teamCalendarSettings.oncall[index].scheduleId =
              original.scheduleId;
            this.settings.teamCalendarSettings.oncall[index].editing = false;
            this.validationErrorsOncall[index] = {
              calendarId: false,
              scheduleId: false,
            };
            this.$nextTick(() => {
              this.initializeTooltips();
            });
          },
          removeOncallEntry(index, event) {
            const span = event.currentTarget.parentElement;
            const tooltip = bootstrap.Tooltip.getInstance(span);
            if (tooltip) {
              tooltip.hide();
            }
            if (confirm("Are you sure you want to delete this entry?")) {
              this.settings.teamCalendarSettings.oncall.splice(index, 1);
              this.validationErrorsOncall.splice(index, 1);
              this.originalEntriesOncall.splice(index, 1);
              this.onSettingsChanged();
              this.$nextTick(() => {
                this.initializeTooltips();
              });
            }
          },
          canSaveOncall(index) {
            const entry = this.settings.teamCalendarSettings.oncall[index];
            return (
              entry.calendarId.trim() !== "" &&
              entry.scheduleId.trim() !== "" &&
              !this.validationErrorsOncall[index].calendarId &&
              !this.validationErrorsOncall[index].scheduleId &&
              this.settings.enabled
            );
          },
          hasOncallChanges(index) {
            const current = this.settings.teamCalendarSettings.oncall[index];
            const original = this.originalEntriesOncall[index];
            return (
              current.calendarId !== original.calendarId ||
              current.scheduleId !== original.scheduleId
            );
          },
          selectColor(category, colorOption) {
            this.settings.checkSettings.eventColors[category] = colorOption;
            this.onSettingsChanged();
          },
          toggleColorOptions() {
            this.showColorOptions = !this.showColorOptions;
          },
        },
      });
    </script>
  </body>
</html>
